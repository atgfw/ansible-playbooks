- name: Add port 22 rule only to firewalls missing it
  hosts: localhost
  gather_facts: false
  collections:
    - community.digitalocean

  vars:
    do_token: "{{ lookup('env', 'DO_API_TOKEN') }}"
    ssh_rule:
      protocol: tcp
      port_range: "22"
      source_addresses:
        - '161.35.133.150/32'
        - '208.103.13.38/30'
        - '173.165.98.241/29'
        - '138.197.62.57/32'

 tasks:

    - name: Get all DigitalOcean firewalls
      community.digitalocean.digital_ocean_firewall_info:
        oauth_token: "{{ do_token }}"
      register: firewalls_info

    - name: Initialize list of firewalls missing SSH
      set_fact:
        firewalls_missing_ssh: []

    - name: Add firewalls that donâ€™t allow port 22 to list
      set_fact:
        firewalls_missing_ssh: "{{ firewalls_missing_ssh + [item] }}"
      loop: "{{ firewalls_info.data }}"
      when: >
        item.inbound_rules | selectattr('protocol', 'equalto', 'tcp') |
        selectattr('ports', 'defined') |
        selectattr('ports', 'search', '(^22$|^22-[0-9]+$|^[0-9]+-22$|^[0-9]+-[0-9]+$)') |
        list | length == 0
      loop_control:
        label: "{{ item.name }}"

    - name: Normalize inbound rules + add SSH rule
      set_fact:
        inbound_rules_normalized: >-
          {% set result = [] %}
          {% for rule in item.inbound_rules %}
            {% set src = rule.sources if rule.sources is defined else {} %}
            {% set r = {
              'protocol': rule.protocol,
              'port_range': rule.ports,
              'source_addresses': src.addresses if src.addresses is defined else [],
              'source_droplet_ids': src.droplet_ids if src.droplet_ids is defined else []
            } %}
            {% set _ = result.append(r) %}
          {% endfor %}
          {{ result + [ssh_rule] }}
      loop: "{{ firewalls_missing_ssh }}"
      loop_control:
        label: "{{ item.name }}"
      register: inbound_result

    - name: Normalize outbound rules
      set_fact:
        outbound_rules_normalized: >-
          {% set result = [] %}
          {% for rule in item.outbound_rules %}
            {% set dst = rule.destinations if rule.destinations is defined else {} %}
            {% set r = {
              'protocol': rule.protocol,
              'port_range': rule.ports,
              'destination_addresses': dst.addresses if dst.addresses is defined else [],
              'destination_droplet_ids': dst.droplet_ids if dst.droplet_ids is defined else []
            } %}
            {% set _ = result.append(r) %}
          {% endfor %}
          {{ result }}
      loop: "{{ firewalls_missing_ssh }}"
      loop_control:
        label: "{{ item.name }}"
      register: outbound_result

    - name: Initialize normalized firewall list
      set_fact:
        normalized_firewalls: []

    - name: Combine all normalized data into final firewall config list
      set_fact:
        normalized_firewalls: "{{ normalized_firewalls + [ {
          'name': firewalls_missing_ssh[item].name,
          'droplet_ids': firewalls_missing_ssh[item].droplet_ids,
          'inbound_rules': inbound_result.results[item].ansible_facts.inbound_rules_normalized | from_yaml,
          'outbound_rules': outbound_result.results[item].ansible_facts.outbound_rules_normalized | from_yaml
        } ] }}"
      loop: "{{ range(0, firewalls_missing_ssh | length) | list }}"
      loop_control:
        label: "{{ firewalls_missing_ssh[item].name }}"
      vars:
        item: "{{ item }}"

    - name: Apply updated firewall configs with SSH rule
      community.digitalocean.digital_ocean_firewall:
        oauth_token: "{{ do_token }}"
        state: present
        name: "{{ item.name }}"
        inbound_rules: "{{ item.inbound_rules }}"
        outbound_rules: "{{ item.outbound_rules }}"
        droplet_ids: "{{ item.droplet_ids }}"
      loop: "{{ normalized_firewalls }}"
      loop_control:
        label: "{{ item.name }}"
